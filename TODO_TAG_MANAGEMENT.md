# 標籤管理功能整合 - 任務清單

## Phase 1：資料庫變更申請
- [x] 建立資料庫變更申請文件（DB_CHANGE_REQUEST_TAG_MANAGEMENT.md）
- [x] 等待使用者確認資料庫變更
- [x] 記錄使用者的修改建議（商品編號格式、標籤上限）

## Phase 2：執行資料庫 migration
- [x] 更新 drizzle/schema.ts 新增 tag_type 欄位
- [x] 執行 pnpm db:push 推送到 Railway PostgreSQL
- [x] 驗證欄位新增成功
- [x] 修正 TypeScript 型別錯誤

## Phase 3：實作智慧標籤排序系統
- [x] 更新 server/db.ts 新增智慧排序查詢函數
  - [x] `isProductCode` - 商品編號格式驗證
  - [x] `getTagsByType` - 依類型篩選標籤
  - [x] `calculateVideoScore` - 計算影片智慧分數
  - [x] `getVideosBySmartScore` - 依智慧分數排序影片
  - [x] `searchVideosByTags` - 智慧標籤搜尋
- [x] 更新 server/routers.ts 新增/更新 procedures
  - [x] `tags.create` - 支援 tag_type 參數，自動檢測商品編號
  - [x] `tags.update` - 支援 tag_type 修改
  - [x] `tags.getByType` - 依類型查詢標籤
  - [x] `videos.listBySmartScore` - 依智慧分數排序
  - [x] `videos.searchByTags` - 智慧標籤搜尋
- [x] 撰寫測試並驗證所有功能（6 個測試全部通過）

## Phase 4：實作管理頁面標籤編輯器（Manage.tsx）
- [x] 新增標籤選擇器組件（TagSelector.tsx）
  - [x] 多選下拉選單（使用 shadcn/ui Select）
  - [x] 搜尋標籤功能
  - [x] 依類型分組顯示（KEYWORD / PRODUCT_CODE）
  - [x] 顯示標籤使用次數
  - [x] 標籤上限驗證（最多 5 個）
- [x] 整合到影片編輯表單
  - [x] 新增「標籤」欄位
  - [x] 顯示已選標籤預覽（可移除）
  - [x] 標籤權重設定（1-10）
  - [x] 儲存時更新 video_tags 關聯
- [x] 新增「建立新標籤」功能
  - [x] 輸入標籤名稱
  - [x] 自動檢測商品編號格式（英文3碼+數字6碼+a/b/c）
  - [x] 符合格式自動設為 PRODUCT_CODE，否則為 KEYWORD
  - [x] 提供手動切換類型按鈕（管理員專用）
  - [x] 輸入標籤描述與顏色

## Phase 5：實作內部看板標籤篩選（Board.tsx）
- [x] 影片卡片顯示標籤
  - [x] 最多顯示 3 個標籤
  - [x] PRODUCT_CODE 標籤使用特殊樣式（金色邊框）
  - [x] 標籤可點擊跳轉到標籤詳情頁
  - [x] 超過 3 個顯示「+N」提示
- [x] 新增標籤篩選器
  - [x] 多選標籤篩選
  - [x] 依標籤類型篩選（全部/關鍵字/商品編號）
  - [x] 顯示當前篩選的標籤數量
  - [x] 清除篩選按鈕
- [x] 智慧排序選項
  - [x] 依相關度排序（使用智慧排序）
  - [x] 依上傳日期排序
  - [x] 依觀看次數排序

## Phase 6：實作影片詳情頁標籤管理（VideoDetail.tsx）
- [x] 管理員標籤編輯介面
  - [x] 顯示當前影片的所有標籤
  - [x] 「新增標籤」按鈕（開啟標籤選擇器）
  - [x] 「移除標籤」按鈕（每個標籤旁邊）
  - [x] 即時更新標籤列表（無需重新整理）
- [x] 標籤顯示優化
  - [x] PRODUCT_CODE 標籤顯示特殊圖示（📦）
  - [x] 標籤依權重排序顯示
  - [x] 標籤 hover 顯示詳細資訊（使用次數、描述）
- [x] 權限控制
  - [x] 只有管理員可以編輯標籤
  - [x] 一般使用者只能檢視標籤

## Phase 7：測試所有新功能
- [x] 撰寫智慧排序測試
  - [x] 測試 KEYWORD 權重計算
  - [x] 測試 PRODUCT_CODE 權重計算
  - [x] 測試混合標籤排序
- [x] 撰寫標籤管理測試
  - [x] 測試標籤類型建立
  - [x] 測試標籤類型更新
  - [x] 測試標籤類型篩選
- [x] 測試前端整合
  - [x] 測試管理頁面標籤編輯器
  - [x] 測試內部看板標籤篩選
  - [x] 測試影片詳情頁標籤管理
- [x] 測試向後相容性
  - [x] 確認現有標籤正常顯示
  - [x] 確認現有 AP## Phase 8：建立 checkpoint 並部署到 Railway
- [x] 更新 TODO 標記所有任務完成
- [x] 建立 checkpoint (aaef9793)
- [ ] 推送到 GitHub
- [ ] 驗證 Railway 自動部署
- [ ] 測試生產環境功能

---

## 功能規格總結

### 智慧標籤排序系統

**權重計算公式：**
```
影片總分 = Σ (標籤使用次數 × 標籤類型權重)

標籤類型權重：
- KEYWORD: 1
- PRODUCT_CODE: 10000
```

**排序範例：**
- 影片 A：理料機(30) + 維修(15) = 45 分
- 影片 B：理料機(30) + 維修(15) + 人為(1) = 46 分
- 影片 C：PM6123456A(5×10000) + 理料機(30) = 50030 分 ⭐

### 管理頁面標籤編輯器

**功能：**
- 多選下拉選單（可搜尋）
- 依類型分組顯示
- 顯示標籤使用次數
- 已選標籤預覽（可移除）
- 標籤權重設定（1-10）
- 建立新標籤功能

**UI 設計：**
```
┌─────────────────────────────────────┐
│ 標籤選擇器                           │
├─────────────────────────────────────┤
│ 🔍 搜尋標籤...                       │
├─────────────────────────────────────┤
│ 📦 商品編號 (PRODUCT_CODE)           │
│   ☑ PM6123456A (5次)                │
│   ☐ PM7890123B (2次)                │
├─────────────────────────────────────┤
│ 🏷️ 關鍵字 (KEYWORD)                 │
│   ☑ 理料機 (30次)                    │
│   ☑ 維修 (15次)                      │
│   ☐ 人為 (1次)                       │
└─────────────────────────────────────┘

已選標籤：
[📦 PM6123456A ×] [🏷️ 理料機 ×] [🏷️ 維修 ×]
```

### 內部看板標籤篩選

**功能：**
- 影片卡片顯示標籤（最多 3 個）
- PRODUCT_CODE 標籤特殊樣式（金色邊框）
- 多選標籤篩選
- 依標籤類型篩選
- 智慧排序選項

**UI 設計：**
```
┌─────────────────────────────────────┐
│ 篩選器                               │
├─────────────────────────────────────┤
│ 標籤類型： [全部 ▼]                  │
│ 已選標籤： [理料機 ×] [維修 ×]       │
│ 排序方式： [相關度 ▼]                │
│ [清除篩選]                           │
└─────────────────────────────────────┘

影片卡片：
┌─────────────────────────────────────┐
│ 📹 影片標題                          │
│ 標籤：[📦 PM6123456A] [理料機] [維修]│
│ 相關度：50030 分                     │
└─────────────────────────────────────┘
```

### 影片詳情頁標籤管理

**功能：**
- 顯示所有標籤（依權重排序）
- 管理員可新增/移除標籤
- PRODUCT_CODE 標籤特殊圖示
- 標籤 hover 顯示詳細資訊
- 即時更新（無需重新整理）

**UI 設計：**
```
┌─────────────────────────────────────┐
│ 影片標籤                             │
├─────────────────────────────────────┤
│ [📦 PM6123456A] [×]                 │
│   使用次數：5 次                     │
│   商品編號標籤                       │
├─────────────────────────────────────┤
│ [🏷️ 理料機] [×]                     │
│   使用次數：30 次                    │
│   關鍵字標籤                         │
├─────────────────────────────────────┤
│ [🏷️ 維修] [×]                       │
│   使用次數：15 次                    │
│   關鍵字標籤                         │
├─────────────────────────────────────┤
│ [+ 新增標籤]                         │
└─────────────────────────────────────┘
```

---

## 注意事項

1. **資料庫變更**：所有 schema 變更必須先獲得使用者確認
2. **向後相容**：確保新功能不影響現有系統運作
3. **測試優先**：每個 Phase 完成後立即撰寫測試
4. **漸進式開發**：每個 Phase 獨立完成，可隨時 rollback
5. **PostgreSQL 語法**：禁用 MySQL/TiDB 語法，一律使用 PostgreSQL
6. **權重調整**：PRODUCT_CODE 權重可依需求調整（目前為 10000）
7. **效能考量**：智慧排序在資料庫層面實作，避免前端計算
8. **使用者體驗**：PRODUCT_CODE 標籤使用特殊樣式，讓使用者一眼識別
