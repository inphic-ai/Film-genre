# 資料庫變更申請：標籤管理功能整合

## 變更日期
2025-12-06

## 變更目的
實作智慧標籤排序系統，新增標籤類型欄位（KEYWORD vs PRODUCT_CODE），支援不同權重計算，讓商品編號標籤優先顯示。

---

## A. 受影響資料表

- **tags** table

---

## B. 欄位變更細節

### 新增欄位

1. **tag_type** VARCHAR(20) DEFAULT 'KEYWORD'
   - 說明：標籤類型，用於智慧排序權重計算
   - 可選值：
     - `'KEYWORD'`：一般關鍵字標籤（權重 = 使用次數）
     - `'PRODUCT_CODE'`：商品編號標籤（權重 = 使用次數 × 10000）
   - 預設值：`'KEYWORD'`
   - 索引：建議新增（用於標籤類型篩選）
   - NOT NULL 約束：是

### 修改欄位
無

### 刪除欄位
無

---

## C. 相容性風險評估

### 1. 是否影響現有資料？

**影響程度：低**

- ✅ 新增欄位有預設值 `'KEYWORD'`
- ✅ 現有標籤自動設定為 `'KEYWORD'` 類型
- ✅ 不影響現有標籤的顯示與查詢
- ✅ 向後相容：未指定類型的標籤預設為 KEYWORD

**資料遷移計畫：**
```sql
-- 新欄位自動套用預設值，無需手動遷移
-- 如需將特定標籤標記為 PRODUCT_CODE：
UPDATE tags 
SET tag_type = 'PRODUCT_CODE' 
WHERE name LIKE 'PM%' OR name LIKE '%[0-9]%';
```

### 2. 是否造成現場系統中斷？

**風險：無**

- ✅ 新增欄位不影響現有查詢
- ✅ 所有現有 API 繼續正常運作
- ✅ 前端頁面不會因新欄位而報錯
- ✅ 智慧排序為新增功能，不影響現有排序邏輯

### 3. 是否可能產生孤兒資料？

**風險：無**

- ✅ 不涉及外鍵變更
- ✅ 不刪除任何欄位
- ✅ 不修改關聯表結構
- ✅ `video_tags` 關聯表完全不受影響

### 4. 若失敗如何回滾？

**回滾步驟：**

```sql
-- Step 1: 移除新增的欄位
ALTER TABLE tags DROP COLUMN IF EXISTS tag_type;

-- Step 2: 驗證回滾成功
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'tags' 
  AND column_name = 'tag_type';
-- 應返回 0 筆結果

-- Step 3: 重啟應用程式
-- Railway 會自動重新部署
```

**回滾影響評估：**
- ✅ 回滾後系統恢復到變更前狀態
- ✅ 不影響現有標籤資料
- ✅ 不影響影片標籤關聯
- ⚠️ 智慧排序功能將失效（回到原始排序）

---

## D. 智慧排序邏輯說明

### 排序權重計算公式

```
影片總分 = Σ (標籤使用次數 × 標籤類型權重)

標籤類型權重：
- KEYWORD: 1
- PRODUCT_CODE: 10000
```

### 範例

**標籤套用次數：**
- 理料機 (KEYWORD, 30次)
- 維修 (KEYWORD, 15次)
- 人為 (KEYWORD, 1次)
- PM6123456A (PRODUCT_CODE, 5次)

**影片排序：**

| 影片 | 標籤組合 | 計算公式 | 總分 | 排序 |
|------|---------|---------|------|------|
| 影片 A | 理料機 + 維修 | 30×1 + 15×1 | 45 | 3 |
| 影片 B | 理料機 + 維修 + 人為 | 30×1 + 15×1 + 1×1 | 46 | 2 |
| 影片 C | PM6123456A + 理料機 | 5×10000 + 30×1 | 50030 | 1 ⭐ |

**結論：** 商品編號標籤（PRODUCT_CODE）會大幅提升影片排序，確保相關影片優先顯示。

---

## E. 實作計畫

### Phase 1: 資料庫變更
- [x] 建立變更申請文件
- [ ] 等待使用者確認
- [ ] 執行 schema 更新
- [ ] 驗證欄位新增成功

### Phase 2: 後端 API 更新
- [ ] 更新 `tags.create` procedure 支援 tag_type 參數
- [ ] 更新 `tags.update` procedure 支援 tag_type 修改
- [ ] 新增 `tags.getByType` procedure 依類型篩選標籤
- [ ] 更新 `videoTags.getTagVideos` 實作智慧排序

### Phase 3: 前端整合
- [ ] 管理頁面：標籤編輯器（多選下拉選單）
- [ ] 內部看板：標籤篩選與顯示
- [ ] 影片詳情頁：標籤管理介面
- [ ] 標籤排行頁：依類型分組顯示

### Phase 4: 測試與部署
- [ ] 撰寫智慧排序測試
- [ ] 測試標籤類型篩選
- [ ] 測試前端整合功能
- [ ] 建立 checkpoint 並部署

---

## F. 商品編號格式規則

### 格式定義

**商品編號格式：英文3碼 + 數字6碼 + a/b/c**

```
範例：QJD0020010A

結構：
┌─────┬─────┬─────┬─────┬─────┬─────┐
│ QJD │ 002 │  0  │  0  │  1  │  A  │
├─────┼─────┼─────┼─────┼─────┼─────┤
│商品 │流水 │規格 │顏色 │採購 │備註 │
│大類 │ 號  │大小 │     │ 人  │     │
└─────┴─────┴─────┴─────┴─────┴─────┘

正則表達式：^[A-Z]{3}\d{6}[a-cA-C]$
```

### 驗證規則

1. **前端驗證**
   - 輸入標籤時自動檢測是否符合商品編號格式
   - 符合格式自動標記為 PRODUCT_CODE 類型
   - 不符合格式預設為 KEYWORD 類型
   - 提供「手動切換類型」選項（管理員專用）

2. **後端驗證**
   ```typescript
   function isProductCode(tagName: string): boolean {
     return /^[A-Z]{3}\d{6}[a-cA-C]$/.test(tagName);
   }
   ```

3. **標籤上限**
   - 每個影片最多 5 個標籤
   - 超過上限顯示錯誤提示
   - 建議：至少 1 個 PRODUCT_CODE + 最多 4 個 KEYWORD

## G. 注意事項

1. **標籤類型判斷邏輯**
   - 商品編號格式：英文3碼 + 數字6碼 + a/b/c（如 QJD0020010A）
   - 自動檢測格式，符合則標記為 PRODUCT_CODE
   - 建議在前端提供「手動切換類型」按鈕（管理員專用）
   - 避免手動輸入錯誤導致類型誤判

2. **權重係數調整**
   - 目前 PRODUCT_CODE 權重為 10000
   - 可依實際需求調整（建議範圍：1000-100000）
   - 權重過高可能導致其他標籤完全失效

3. **效能考量**
   - 智慧排序需要計算所有標籤權重
   - 建議在資料庫層面實作（避免前端計算）
   - 考慮新增快取機制（Redis）

4. **使用者體驗**
   - 前端顯示標籤時，PRODUCT_CODE 使用不同顏色/圖示
   - 標籤篩選器支援「只顯示商品編號」選項
   - 排序結果顯示「相關度分數」讓使用者理解排序邏輯

---

## H. 確認事項

請確認以下事項後回覆「確認」，我將開始執行 Phase 2（資料庫 migration）：

- [ ] 同意新增 `tag_type` 欄位到 `tags` 資料表
- [ ] 同意智慧排序邏輯（PRODUCT_CODE 權重 × 10000）
- [ ] 了解回滾步驟與影響範圍
- [ ] 確認不影響現有系統運作
- [ ] 同意實作計畫的 4 個 Phase

或者，如果您有任何疑問或修改建議，請告訴我！
