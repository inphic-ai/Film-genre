# 影片知識庫系統 - 後續優先開發功能規劃

**文件版本**: 1.0  
**建立時間**: 2025-12-07  
**規劃依據**: Phase 18 使用者回饋與 P2 階段功能需求

---

## 優先級分類

### P0（最高優先級）- 核心功能完善
影響使用者體驗的關鍵功能，建議立即開發。

### P1（高優先級）- 重要功能增強
提升系統價值的重要功能，建議近期開發。

### P2（中優先級）- 進階功能
增強系統完整性的功能，可排入中期規劃。

### P3（低優先級）- 優化與擴展
錦上添花的功能，可視資源情況開發。

---

## P0 - 核心功能完善

### 1. 縮圖上傳系統前端實作 🎨
**狀態**: 後端已完成，待實作前端  
**預估工時**: 4-6 小時  
**優先級**: P0

**功能需求**：
1. 新增影片對話框新增「自訂縮圖」上傳欄位（選擇性）
2. 預設顯示 YouTube 圖示（當無自訂縮圖時）
3. 縮圖預覽、換圖、刪除功能
4. 影片卡片優先顯示自訂縮圖，無則顯示 YouTube 縮圖

**技術實作**：
- 使用 `<input type="file" accept="image/*">` 上傳圖片
- 前端將圖片轉換為 Base64 格式
- 呼叫 `trpc.videos.uploadThumbnail.useMutation()` 上傳
- 呼叫 `trpc.videos.deleteThumbnail.useMutation()` 刪除
- 在 VideoCard 組件中優先顯示 `customThumbnailUrl`

**相關檔案**：
- `client/src/pages/Board.tsx`（新增影片對話框）
- `client/src/components/VideoCard.tsx`（縮圖顯示邏輯）
- `server/routers.ts`（已完成）

---

### 2. 影片播放器優化 🎬
**狀態**: 已修復比例問題，待進一步優化  
**預估工時**: 2-3 小時  
**優先級**: P0

**已完成**：
- ✅ 修復播放器比例問題（移除雙層 aspect-video 容器）

**待優化**：
1. 播放器載入狀態（Skeleton Loading）
2. 播放器錯誤處理（影片無法載入時顯示友善訊息）
3. 播放器控制列優化（音量控制、全螢幕按鈕）
4. 支援小紅書、抖音影片嵌入（目前僅支援 YouTube）

**技術實作**：
- 在 `YouTubePlayer.tsx` 新增 loading 與 error 狀態
- 使用 Skeleton 組件顯示載入中狀態
- 新增錯誤邊界（Error Boundary）處理播放器錯誤

---

## P1 - 重要功能增強

### 3. 通知系統 🔔
**狀態**: 資料庫 Schema 已建立，待實作後端與前端  
**預估工時**: 6-8 小時  
**優先級**: P1

**功能需求**：
1. 審核結果通知（影片審核通過/拒絕）
2. 系統公告通知（管理員發布重要訊息）
3. 標籤更新通知（影片標籤被修改）
4. 通知中心頁面（/notifications）
5. 通知鈴鐺圖示（顯示未讀數量）

**技術實作**：
- 後端 API：`notifications.list`、`notifications.markAsRead`、`notifications.markAllAsRead`
- 前端頁面：`client/src/pages/Notifications.tsx`
- 側邊欄整合：在 `DashboardLayout.tsx` 新增通知鈴鐺圖示
- 自動通知觸發：在審核流程中自動建立通知記錄

**相關檔案**：
- `server/trpc/routers/notifications.ts`（新建）
- `client/src/pages/Notifications.tsx`（新建）
- `client/src/components/DashboardLayout.tsx`（修改）

---

### 4. 商品知識中樞進階功能 📦
**狀態**: 基礎功能已完成，待新增進階功能  
**預估工時**: 8-10 小時  
**優先級**: P1

**功能需求**：
1. **商品縮圖上傳**（整合 Cloudflare R2）
   - 商品詳情頁新增縮圖上傳功能
   - 支援多張圖片上傳（產品圖、使用情境圖）
   - 圖片預覽與刪除功能

2. **批次匯入 SKU 資料**（CSV/Excel）
   - 上傳 CSV/Excel 檔案批次新增商品
   - 支援欄位對應（SKU、名稱、描述、分類）
   - 匯入結果預覽與錯誤提示

3. **商品關聯視覺化**
   - 使用圖表顯示商品之間的關聯關係
   - 顯示「家族 SKU」、「同義 SKU」、「關聯商品」
   - 支援拖曳調整關聯關係

**技術實作**：
- 商品縮圖：使用 `storagePut` 上傳到 S3
- 批次匯入：使用 `papaparse` 解析 CSV，`xlsx` 解析 Excel
- 視覺化：使用 `react-flow` 或 `cytoscape.js` 繪製關聯圖

**相關檔案**：
- `server/trpc/routers/products.ts`（修改）
- `client/src/pages/Products.tsx`（修改）
- `client/src/components/ProductRelationGraph.tsx`（新建）

---

### 5. 全文搜尋優化 🔍
**狀態**: 基礎功能已完成，待優化效能與體驗  
**預估工時**: 4-6 小時  
**優先級**: P1

**已完成**：
- ✅ PostgreSQL tsvector 全文搜尋
- ✅ 搜尋建議（自動完成）
- ✅ 整合到全域搜尋框

**待優化**：
1. **搜尋結果高亮**（Highlight 關鍵字）
2. **搜尋歷史記錄**（儲存最近 10 次搜尋）
3. **熱門搜尋關鍵字**（顯示最常搜尋的關鍵字）
4. **搜尋篩選器**（按平台、分類、時間範圍篩選）
5. **搜尋結果排序**（相關性、時間、觀看次數）

**技術實作**：
- 使用 `ts_headline` 函數高亮搜尋關鍵字
- 使用 localStorage 儲存搜尋歷史
- 新增 `searchLogs` 表記錄搜尋行為
- 在搜尋結果頁面新增篩選器與排序選項

---

## P2 - 進階功能

### 6. 影片批次操作 📋
**預估工時**: 4-6 小時  
**優先級**: P2

**功能需求**：
1. 批次選擇影片（Checkbox）
2. 批次修改分類
3. 批次修改分享狀態
4. 批次新增標籤
5. 批次刪除影片

**技術實作**：
- 在 `Board.tsx` 新增批次選擇模式
- 新增 `videos.batchUpdate` API
- 使用樂觀更新（Optimistic Update）提升體驗

---

### 7. 影片分析統計 📊
**預估工時**: 6-8 小時  
**優先級**: P2

**功能需求**：
1. 觀看次數趨勢圖（過去 7 天、30 天）
2. 熱門影片排行榜（Top 10）
3. 分類分布圖（圓餅圖）
4. 標籤使用統計（長條圖）
5. 平台分布統計

**技術實作**：
- 新增 `analytics` router
- 使用 `recharts` 繪製圖表
- 新增 `viewLogs` 表記錄觀看行為（可選）

---

### 8. 影片評論系統 💬
**預估工時**: 8-10 小時  
**優先級**: P2

**功能需求**：
1. 影片詳情頁新增評論區
2. 支援回覆評論（巢狀評論）
3. 評論按讚/倒讚
4. 評論排序（最新、最熱門）
5. 管理員可刪除不當評論

**技術實作**：
- 新增 `comments` 表（videoId, userId, content, parentId, likes, createdAt）
- 新增 `comments` router
- 使用遞迴查詢載入巢狀評論

---

## P3 - 優化與擴展

### 9. 影片下載功能 ⬇️
**預估工時**: 3-4 小時  
**優先級**: P3

**功能需求**：
1. YouTube 影片下載（使用 yt-dlp）
2. 下載進度顯示
3. 下載歷史記錄

**技術實作**：
- 使用 `yt-dlp` 下載 YouTube 影片
- 使用 WebSocket 推送下載進度
- 儲存下載檔案到 S3

---

### 10. 影片轉碼與壓縮 🎞️
**預估工時**: 6-8 小時  
**優先級**: P3

**功能需求**：
1. 影片格式轉換（MP4、WebM、AVI）
2. 影片壓縮（降低檔案大小）
3. 影片截圖（自動生成縮圖）

**技術實作**：
- 使用 `ffmpeg` 進行影片處理
- 使用佇列系統（Bull）處理長時間任務
- 儲存處理後的影片到 S3

---

### 11. 多語言支援 🌐
**預估工時**: 4-6 小時  
**優先級**: P3

**功能需求**：
1. 繁體中文（預設）
2. 簡體中文
3. 英文

**技術實作**：
- 使用 `react-i18next` 實作多語言
- 建立語言檔案（zh-TW, zh-CN, en）
- 在設定頁面新增語言切換選項

---

### 12. 暗黑模式 🌙
**預估工時**: 3-4 小時  
**優先級**: P3

**功能需求**：
1. 亮色模式 / 暗色模式切換
2. 跟隨系統主題
3. 記住使用者偏好

**技術實作**：
- 使用 `next-themes` 或 shadcn/ui 的 ThemeProvider
- 在 `index.css` 定義暗色主題變數
- 在設定頁面新增主題切換選項

---

## 建議開發順序

根據使用者回饋與系統完整性，建議以下開發順序：

### 第一階段（1-2 週）
1. ✅ **縮圖上傳系統前端實作**（P0）- 完成使用者回饋的核心需求
2. **影片播放器優化**（P0）- 提升影片觀看體驗
3. **通知系統**（P1）- 完善審核流程閉環

### 第二階段（2-3 週）
4. **商品知識中樞進階功能**（P1）- 提升商品管理效率
5. **全文搜尋優化**（P1）- 提升搜尋體驗
6. **影片批次操作**（P2）- 提升管理效率

### 第三階段（3-4 週）
7. **影片分析統計**（P2）- 提供數據洞察
8. **影片評論系統**（P2）- 增強互動性
9. **多語言支援**（P3）- 擴展使用者群

### 第四階段（視需求）
10. **影片下載功能**（P3）
11. **影片轉碼與壓縮**（P3）
12. **暗黑模式**（P3）

---

## 技術債務清單

以下是目前系統中需要優化的技術債務：

### 1. 全文搜尋效能優化
**問題**：目前使用 `to_tsvector` 即時生成搜尋向量，效能較差  
**解決方案**：使用 PostgreSQL 觸發器自動更新 `searchVector` 欄位

### 2. 圖片上傳檔案大小限制
**問題**：目前無檔案大小限制，可能導致 S3 儲存成本過高  
**解決方案**：前端限制檔案大小（例如 5MB），後端驗證檔案大小

### 3. 錯誤處理與日誌記錄
**問題**：目前錯誤處理較為簡單，缺乏詳細日誌  
**解決方案**：整合 Sentry 或 LogRocket 進行錯誤追蹤

### 4. API 速率限制
**問題**：目前無 API 速率限制，可能遭受 DDoS 攻擊  
**解決方案**：使用 `express-rate-limit` 限制 API 請求頻率

### 5. 資料庫索引優化
**問題**：部分查詢缺乏索引，可能影響效能  
**解決方案**：為常用查詢欄位新增索引（例如 `videos.productId`、`tags.name`）

---

## 總結

根據使用者回饋與系統現況，建議優先完成以下功能：

1. **縮圖上傳系統前端實作**（P0）- 完成使用者回饋的核心需求
2. **影片播放器優化**（P0）- 提升影片觀看體驗
3. **通知系統**（P1）- 完善審核流程閉環

這三項功能將顯著提升系統的使用者體驗與完整性，建議作為下一階段的開發重點。

---

**文件維護**：本文件將隨著開發進度持續更新，請定期檢視並調整優先級。
