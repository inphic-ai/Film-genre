# INPHIC 影片知識庫系統 - 效能優化規劃

## 文件資訊
- **建立時間**：2025-12-08 18:00 GMT+8
- **目標**：實施高優先級效能優化項目，建立效能監控儀表板
- **符合規範**：《INPHIC × Manus 生產環境合作規範 1.0》

---

## 一、效能優化目標

### 核心目標
1. **提升資料庫查詢效能**：新增索引，減少查詢時間 50%+
2. **保護 API 穩定性**：實作速率限制，防止濫用與過載
3. **改善前端體驗**：大列表虛擬滾動，支援 1000+ 項目流暢滾動
4. **建立效能監控**：即時監控系統效能，快速發現瓶頸

### 成功指標
- 影片列表載入時間 < 500ms（目前約 1-2s）
- API 回應時間 < 200ms（P95）
- 前端列表滾動 FPS > 50（1000+ 項目）
- 資料庫查詢時間 < 100ms（P95）

---

## 二、效能監控儀表板入口設計

### 方案討論

#### **方案 A：整合到現有「數據視覺化」頁面（推薦）**

**優點**：
- ✅ 符合現有導航結構（數據視覺化 = Dashboard）
- ✅ 使用者心智模型一致（效能監控 = 系統數據）
- ✅ 減少導航項目，避免側邊欄過於擁擠
- ✅ 實作成本低（新增 Tab 即可）

**缺點**：
- ⚠️ 數據視覺化頁面可能變得複雜（需要良好的 Tab 設計）

**實作方式**：
```
數據視覺化頁面（/dashboard）
├── Tab 1: 綜合統計（現有）
│   ├── 統計卡片（總影片數、總商品數、時間軸筆記、待審核筆記）
│   ├── 影片統計圖表（分類分佈、平台分佈）
│   ├── 商品分析儀表板
│   └── 使用者活動追蹤
├── Tab 2: 效能監控（新增）★
│   ├── 系統效能指標（CPU、記憶體、資料庫連線）
│   ├── API 效能監控（回應時間、錯誤率、速率限制統計）
│   ├── 資料庫效能（查詢時間、慢查詢列表、索引使用率）
│   └── 前端效能（頁面載入時間、FPS、資源大小）
└── Tab 3: 效能優化建議（新增）
    ├── 自動偵測效能瓶頸
    ├── 優化建議列表
    └── 歷史優化記錄
```

---

#### **方案 B：新增獨立「效能監控」導航項目**

**優點**：
- ✅ 功能獨立，職責清晰
- ✅ 適合未來擴充（效能分析、日誌查詢等）

**缺點**：
- ❌ 側邊欄導航項目增加（目前已有 8 個）
- ❌ 使用者需要記住新的入口位置
- ❌ 實作成本較高（新增路由、頁面、導航項目）

**實作方式**：
```
側邊欄導航
├── 數據視覺化（現有）
├── 影片看板（現有）
├── 商品知識中樞（現有）
├── 我的貢獻（現有）
├── 通知中心（現有）
├── 標籤管理（現有，Admin 專用）
├── 系統管理（現有，Admin 專用）
├── 審核中心（現有，Admin 專用）
└── 效能監控（新增，Admin 專用）★
```

---

#### **方案 C：整合到「系統管理」頁面**

**優點**：
- ✅ 符合「系統管理」的職責範圍
- ✅ 不增加導航項目

**缺點**：
- ⚠️ 系統管理頁面已有 3 個 Tab（使用者管理、操作日誌、系統設定）
- ⚠️ 效能監控與系統管理的關聯性較弱

**實作方式**：
```
系統管理頁面（/admin/settings）
├── Tab 1: 使用者管理（現有）
├── Tab 2: 操作日誌（現有）
├── Tab 3: 系統設定（現有）
└── Tab 4: 效能監控（新增）★
```

---

### 推薦方案：**方案 A（整合到數據視覺化頁面）**

**理由**：
1. **符合使用者心智模型**：效能監控 = 系統數據 = 數據視覺化
2. **實作成本最低**：新增 Tab 即可，無需新增路由與導航項目
3. **避免側邊欄過於擁擠**：目前已有 8 個導航項目
4. **易於維護**：效能監控與綜合統計共用相同的資料來源（資料庫、API）

**實作細節**：
- 路由：`/dashboard?tab=performance`（使用 URL 參數切換 Tab）
- 權限：Admin 專用（與現有數據視覺化頁面一致）
- UI 設計：使用 Tabs 組件（shadcn/ui）

---

## 三、效能優化實施計畫

### Phase 1：資料庫效能優化（新增索引）

**目標**：減少資料庫查詢時間 50%+

**實施項目**：

1. **videos 表索引**
   ```sql
   -- 分類篩選索引
   CREATE INDEX idx_videos_category ON videos(category);
   
   -- 平台篩選索引
   CREATE INDEX idx_videos_platform ON videos(platform);
   
   -- 分享狀態篩選索引
   CREATE INDEX idx_videos_share_status ON videos("shareStatus");
   
   -- 評分排序索引
   CREATE INDEX idx_videos_rating ON videos(rating DESC NULLS LAST);
   
   -- 建立時間排序索引
   CREATE INDEX idx_videos_created_at ON videos("createdAt" DESC);
   
   -- 觀看次數排序索引
   CREATE INDEX idx_videos_view_count ON videos("viewCount" DESC);
   
   -- 複合索引（分類 + 平台 + 分享狀態）
   CREATE INDEX idx_videos_filter ON videos(category, platform, "shareStatus");
   ```

2. **timeline_notes 表索引**
   ```sql
   -- 影片 ID 索引（查詢特定影片的筆記）
   CREATE INDEX idx_timeline_notes_video_id ON timeline_notes("videoId");
   
   -- 審核狀態索引（查詢待審核筆記）
   CREATE INDEX idx_timeline_notes_status ON timeline_notes(status);
   
   -- 使用者 ID 索引（查詢特定使用者的筆記）
   CREATE INDEX idx_timeline_notes_user_id ON timeline_notes("userId");
   
   -- 複合索引（影片 ID + 審核狀態）
   CREATE INDEX idx_timeline_notes_video_status ON timeline_notes("videoId", status);
   ```

3. **video_tags 表索引**
   ```sql
   -- 影片 ID 索引（查詢特定影片的標籤）
   CREATE INDEX idx_video_tags_video_id ON video_tags("videoId");
   
   -- 標籤 ID 索引（查詢特定標籤的影片）
   CREATE INDEX idx_video_tags_tag_id ON video_tags("tagId");
   ```

4. **tags 表索引**
   ```sql
   -- 標籤類型索引
   CREATE INDEX idx_tags_type ON tags("tagType");
   
   -- 智慧排序索引
   CREATE INDEX idx_tags_smart_score ON tags("smartScore" DESC);
   ```

5. **products 表索引**
   ```sql
   -- SKU 索引（唯一索引）
   CREATE UNIQUE INDEX idx_products_sku ON products(sku);
   
   -- 家族碼索引
   CREATE INDEX idx_products_family_code ON products("familyCode");
   ```

**資料庫變更申請**：
- 需提交 Schema 變更申請（符合《INPHIC × Manus 生產環境合作規範 1.0》）
- 索引不影響資料，僅影響查詢效能
- 建議在低峰時段執行（避免影響生產環境）

---

### Phase 2：API 速率限制實作

**目標**：防止 API 濫用與過載

**實施項目**：

1. **速率限制策略**
   - **全域限制**：每個 IP 每分鐘 60 次請求
   - **認證使用者**：每個使用者每分鐘 120 次請求
   - **Admin 使用者**：每個 Admin 每分鐘 300 次請求
   - **特殊端點**：
     - AI 搜尋：每個使用者每分鐘 10 次請求
     - 批次匯入：每個使用者每小時 5 次請求
     - 圖片上傳：每個使用者每分鐘 20 次請求

2. **技術實作**
   - 使用 `express-rate-limit` 套件
   - 使用 Redis 儲存速率限制狀態（Railway Redis）
   - 返回標準 HTTP 429 錯誤（Too Many Requests）
   - 提供 `X-RateLimit-*` 標頭（Limit, Remaining, Reset）

3. **錯誤處理**
   - 前端顯示友善錯誤訊息（「請求過於頻繁，請稍後再試」）
   - 後端記錄速率限制事件（audit logs）
   - 效能監控儀表板顯示速率限制統計

---

### Phase 3：大列表虛擬滾動實作

**目標**：支援 1000+ 項目流暢滾動

**實施項目**：

1. **影片看板頁面（Board.tsx）**
   - 使用 `react-window` 或 `react-virtualized` 套件
   - 虛擬滾動網格佈局（Grid）
   - 支援動態高度（影片卡片高度不固定）
   - 保留篩選與排序功能

2. **標籤管理頁面（TagsManagement.tsx）**
   - 虛擬滾動列表（List）
   - 支援搜尋與篩選
   - 保留新增/編輯/刪除功能

3. **審核中心頁面（ReviewCenter.tsx）**
   - 虛擬滾動列表（List）
   - 支援批次審核
   - 保留篩選與排序功能

4. **技術細節**
   - 使用 `react-window` 套件（輕量級，效能優異）
   - 實作 `FixedSizeList`（固定高度）或 `VariableSizeList`（動態高度）
   - 實作 `FixedSizeGrid`（網格佈局）
   - 保留現有的 UI 設計與互動邏輯

---

### Phase 4：效能監控儀表板開發

**目標**：即時監控系統效能

**實施項目**：

1. **系統效能指標**
   - CPU 使用率（Railway Metrics API）
   - 記憶體使用率（Railway Metrics API）
   - 資料庫連線數（PostgreSQL）
   - 磁碟使用率（Railway Metrics API）

2. **API 效能監控**
   - API 回應時間（P50, P95, P99）
   - API 錯誤率（4xx, 5xx）
   - 速率限制統計（觸發次數、被限制的 IP）
   - 最慢 API 列表（Top 10）

3. **資料庫效能**
   - 查詢時間（P50, P95, P99）
   - 慢查詢列表（> 1s）
   - 索引使用率
   - 連線池狀態

4. **前端效能**
   - 頁面載入時間（First Contentful Paint, Largest Contentful Paint）
   - 互動延遲（First Input Delay）
   - 累積佈局偏移（Cumulative Layout Shift）
   - 資源大小（JS, CSS, Images）

5. **技術實作**
   - 後端：新增 `performance` router（tRPC）
   - 前端：新增「效能監控」Tab（Dashboard.tsx）
   - 圖表：使用 Recharts 或 Chart.js
   - 資料來源：
     - Railway Metrics API（系統指標）
     - PostgreSQL pg_stat_statements（資料庫指標）
     - 自訂中介軟體（API 指標）
     - Web Vitals API（前端指標）

---

## 四、實施順序與時程

### 優先順序

1. **P0（立即實施）**：資料庫索引優化
   - 影響最大，實作成本最低
   - 預估時間：2 小時

2. **P1（高優先級）**：API 速率限制
   - 保護系統穩定性
   - 預估時間：4 小時

3. **P2（中優先級）**：效能監控儀表板
   - 建立效能基線，便於後續優化
   - 預估時間：6 小時

4. **P3（低優先級）**：大列表虛擬滾動
   - 目前影片數量 < 100，暫時不是瓶頸
   - 預估時間：8 小時

### 實施時程

| Phase | 項目 | 預估時間 | 依賴 |
|-------|------|---------|------|
| 1 | 資料庫索引優化 | 2 小時 | - |
| 2 | API 速率限制 | 4 小時 | - |
| 3 | 效能監控儀表板（後端） | 4 小時 | Phase 1, 2 |
| 4 | 效能監控儀表板（前端） | 2 小時 | Phase 3 |
| 5 | 大列表虛擬滾動 | 8 小時 | - |
| 6 | 效能測試與驗證 | 2 小時 | Phase 1-5 |
| 7 | 部署到生產環境 | 1 小時 | Phase 6 |

**總時間**：23 小時（約 3 個工作天）

---

## 五、風險評估與緩解措施

### 風險 1：資料庫索引影響寫入效能

**風險等級**：低

**緩解措施**：
- 索引僅影響寫入效能 < 5%（PostgreSQL 優化良好）
- 監控寫入效能，如有問題可移除部分索引
- 使用部分索引（Partial Index）減少索引大小

### 風險 2：速率限制誤傷正常使用者

**風險等級**：中

**緩解措施**：
- 設定合理的速率限制閾值（基於歷史資料）
- 提供 Admin 白名單功能
- 記錄所有速率限制事件，便於調整策略

### 風險 3：虛擬滾動破壞現有 UI

**風險等級**：中

**緩解措施**：
- 先在開發環境測試
- 保留現有的篩選與排序功能
- 提供降級方案（< 100 項目時使用傳統滾動）

### 風險 4：效能監控增加系統負載

**風險等級**：低

**緩解措施**：
- 使用採樣策略（不記錄所有請求）
- 使用非同步日誌（不阻塞主線程）
- 定期清理歷史資料（保留 30 天）

---

## 六、成功指標與驗證

### 效能指標

| 指標 | 目標 | 當前 | 改善幅度 |
|------|------|------|---------|
| 影片列表載入時間 | < 500ms | ~1-2s | 50-75% |
| API 回應時間（P95） | < 200ms | ~300-500ms | 40-60% |
| 資料庫查詢時間（P95） | < 100ms | ~200-300ms | 50-67% |
| 前端列表滾動 FPS | > 50 | ~30-40 | 25-67% |

### 驗證方法

1. **資料庫效能**：
   - 使用 `EXPLAIN ANALYZE` 驗證索引使用
   - 比較優化前後的查詢時間

2. **API 效能**：
   - 使用 Artillery 或 k6 進行負載測試
   - 驗證速率限制是否生效

3. **前端效能**：
   - 使用 Chrome DevTools Performance 面板
   - 驗證虛擬滾動 FPS > 50

4. **效能監控**：
   - 驗證儀表板資料準確性
   - 驗證即時更新功能

---

## 七、後續優化建議

### 短期（1-2 週）
- 實作 API 快取（Redis）
- 實作圖片 CDN（Cloudflare R2 + CDN）
- 實作前端資源壓縮（Gzip / Brotli）

### 中期（1-2 月）
- 實作資料庫讀寫分離（PostgreSQL Replica）
- 實作全文搜尋（PostgreSQL Full-Text Search）
- 實作前端 Code Splitting（Vite）

### 長期（3-6 月）
- 實作微服務架構（影片服務、商品服務、使用者服務）
- 實作訊息佇列（RabbitMQ / Redis Pub/Sub）
- 實作分散式追蹤（OpenTelemetry）

---

## 八、參考文件

- 《INPHIC × Manus 生產環境合作規範 1.0》
- `docs/priority-features-roadmap.md`
- Railway PostgreSQL 文件
- PostgreSQL 索引最佳實踐
- React Window 文件
- Express Rate Limit 文件

---

## 九、附錄：效能監控儀表板 UI 設計草稿

### Tab 1：綜合統計（現有）
- 保持不變

### Tab 2：效能監控（新增）

```
┌─────────────────────────────────────────────────────────┐
│ 效能監控                                                 │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 📊 系統效能指標                                          │
│ ┌──────────┬──────────┬──────────┬──────────┐          │
│ │ CPU 使用率│ 記憶體   │ 資料庫   │ 磁碟使用 │          │
│ │   45%    │   62%    │  8/20    │   35%    │          │
│ └──────────┴──────────┴──────────┴──────────┘          │
│                                                          │
│ 📈 API 效能監控                                          │
│ ┌──────────────────────────────────────────┐            │
│ │ 回應時間趨勢圖（過去 24 小時）            │            │
│ │ [折線圖：P50, P95, P99]                  │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ ┌──────────┬──────────┬──────────┬──────────┐          │
│ │ 平均回應 │ P95 回應 │ 錯誤率   │ 速率限制 │          │
│ │  120ms   │  180ms   │  0.5%    │  12 次   │          │
│ └──────────┴──────────┴──────────┴──────────┘          │
│                                                          │
│ 🐢 最慢 API 列表（Top 10）                               │
│ ┌──────────────────────────────────────────┐            │
│ │ 1. videos.list - 350ms                   │            │
│ │ 2. products.search - 280ms               │            │
│ │ 3. aiSearch.search - 250ms               │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ 💾 資料庫效能                                            │
│ ┌──────────────────────────────────────────┐            │
│ │ 查詢時間趨勢圖（過去 24 小時）            │            │
│ │ [折線圖：P50, P95, P99]                  │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ 🐌 慢查詢列表（> 1s）                                    │
│ ┌──────────────────────────────────────────┐            │
│ │ 1. SELECT * FROM videos WHERE ... - 1.2s │            │
│ │ 2. SELECT * FROM products WHERE ... - 1.1s│           │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ 🌐 前端效能                                              │
│ ┌──────────┬──────────┬──────────┬──────────┐          │
│ │ FCP      │ LCP      │ FID      │ CLS      │          │
│ │  800ms   │  1.2s    │  50ms    │  0.05    │          │
│ └──────────┴──────────┴──────────┴──────────┘          │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### Tab 3：效能優化建議（新增）

```
┌─────────────────────────────────────────────────────────┐
│ 效能優化建議                                             │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 🔍 自動偵測效能瓶頸                                      │
│                                                          │
│ ⚠️ 高優先級問題（3 個）                                  │
│ ┌──────────────────────────────────────────┐            │
│ │ 1. videos 表缺少 category 索引            │            │
│ │    影響：查詢時間 +200ms                  │            │
│ │    建議：CREATE INDEX idx_videos_category │            │
│ │    [查看詳情] [立即修復]                  │            │
│ │                                           │            │
│ │ 2. API 回應時間過長（videos.list）        │            │
│ │    影響：P95 回應時間 350ms               │            │
│ │    建議：新增分頁、快取、索引             │            │
│ │    [查看詳情] [查看建議]                  │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ ⚡ 中優先級問題（5 個）                                  │
│ ┌──────────────────────────────────────────┐            │
│ │ 1. 前端資源過大（bundle.js 2.5MB）        │            │
│ │    影響：首次載入時間 +1s                 │            │
│ │    建議：Code Splitting、Tree Shaking     │            │
│ │    [查看詳情] [查看建議]                  │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
│ 📋 歷史優化記錄                                          │
│ ┌──────────────────────────────────────────┐            │
│ │ 2025-12-08 18:00 - 新增 videos 表索引    │            │
│ │ 改善：查詢時間 -50%                       │            │
│ │                                           │            │
│ │ 2025-12-08 17:00 - 實作 API 速率限制     │            │
│ │ 改善：防止 API 濫用                       │            │
│ └──────────────────────────────────────────┘            │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 結論

本文件提供了完整的效能優化規劃，包括：
1. **效能監控儀表板入口設計**（推薦方案 A：整合到數據視覺化頁面）
2. **效能優化實施計畫**（資料庫索引、API 速率限制、虛擬滾動、效能監控）
3. **實施順序與時程**（總時間 23 小時，約 3 個工作天）
4. **風險評估與緩解措施**
5. **成功指標與驗證方法**

請確認規劃方案後，我將開始實施。
