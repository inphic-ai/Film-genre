# 商品知識中樞定義規則

## 一、商品納入標準

### 1.1 什麼是「商品」？

在影片整理網站的「商品知識中樞」中，**商品（Product）** 是指具有以下特徵的實體商品或服務：

1. **具有唯一商品編號（SKU）**
   - SKU 是商品的唯一識別碼
   - 用於追蹤商品資訊、影片關聯與知識管理

2. **與影片內容相關**
   - 商品在影片中被介紹、展示或提及
   - 商品是影片的主題或重要元素

3. **需要知識管理**
   - 商品有多個變體或家族成員
   - 商品有相關零件或配件
   - 商品需要集中管理相關影片與資訊

---

## 二、商品編號（SKU）規則

### 2.1 SKU 格式定義

**標準格式**：`英文3碼 + 數字6碼 + 變體代碼1碼`

**正則表達式**：`/^[A-Z]{3}\d{6}[ABC]$/i`

**範例**：
- ✅ `PM6123456A` - 正確格式
- ✅ `ABC100100A` - 正確格式
- ✅ `MKC007104B` - 正確格式
- ❌ `PM612345` - 缺少變體代碼
- ❌ `PM612345AA` - 變體代碼超過1碼
- ❌ `PM61234A` - 數字碼不足6碼
- ❌ `P6123456A` - 英文碼不足3碼

### 2.2 SKU 組成說明

#### 英文3碼（Product Type）
- 代表商品類型或產品線
- 必須為大寫英文字母
- 範例：
  - `PM6` - 包裝機械
  - `MKC` - 切肉機
  - `ABC` - 其他商品類型

#### 數字6碼（Product ID）
- 代表商品的唯一識別號碼
- 必須為數字
- 範例：`123456`、`007104`、`100100`

#### 變體代碼1碼（Variant）
- 代表商品的變體版本
- 必須為 `A`、`B` 或 `C`
- 範例：
  - `A` - 標準版
  - `B` - 進階版
  - `C` - 專業版

### 2.3 家族代碼（Family Code）

**定義**：SKU 的前 6 碼（英文3碼 + 數字前3碼）

**用途**：
- 將相同家族的商品分組
- 快速查詢家族成員
- 建立商品家族關係

**範例**：
- `PM6123456A` → 家族代碼：`PM6123`
- `PM6123456B` → 家族代碼：`PM6123`
- `PM6123789A` → 家族代碼：`PM6123`

**家族關係**：
- 相同家族代碼的商品屬於同一家族
- 家族成員通常具有相似功能或規格
- 可能是不同型號、尺寸或配置的變體

---

## 三、商品資料結構

### 3.1 必填欄位

| 欄位名稱 | 資料類型 | 說明 | 範例 |
|---------|---------|------|------|
| `sku` | `varchar(50)` | 商品編號（唯一） | `PM6123456A` |
| `name` | `varchar(255)` | 商品名稱 | `多功能商用切肉機` |

### 3.2 選填欄位

| 欄位名稱 | 資料類型 | 說明 | 範例 |
|---------|---------|------|------|
| `description` | `text` | 商品描述 | `適用於雞腿、豬肉、牛肉...` |
| `familyCode` | `varchar(20)` | 家族代碼（自動計算） | `PM6123` |
| `variant` | `varchar(1)` | 變體代碼（自動提取） | `A` |
| `thumbnailUrl` | `text` | 商品縮圖網址 | `https://...` |

### 3.3 系統欄位

| 欄位名稱 | 資料類型 | 說明 |
|---------|---------|------|
| `id` | `integer` | 商品 ID（自動生成） |
| `createdAt` | `timestamp` | 建立時間 |
| `updatedAt` | `timestamp` | 更新時間 |

---

## 四、商品與影片關聯

### 4.1 目前機制

**關聯方式**：影片資料表的 `productId` 欄位儲存商品編號字串

**資料結構**：
```typescript
videos.productId: varchar(100) // 例如："PM6123456A"
```

**查詢方式**：
```sql
SELECT * FROM videos WHERE productId LIKE '%PM6123456A%';
```

### 4.2 關聯限制

1. **單向關聯**
   - 僅能從影片查詢商品
   - 無法從商品反向查詢所有相關影片

2. **單一商品**
   - 一個影片只能關聯一個商品編號
   - 無法表達一個影片介紹多個商品的情況

3. **效能問題**
   - 使用 `LIKE` 查詢效能較差
   - 無法使用索引優化查詢

### 4.3 建議改善方案

**建立中介資料表**：`video_products`

```sql
CREATE TABLE video_products (
  id SERIAL PRIMARY KEY,
  video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(video_id, product_id)
);
```

**優點**：
- ✅ 支援多對多關聯（一個影片可關聯多個商品）
- ✅ 查詢效能提升（使用索引）
- ✅ 資料一致性保證（外鍵約束）
- ✅ 可追蹤關聯建立時間

---

## 五、商品關聯類型

### 5.1 關聯類型定義

商品之間可建立以下三種關聯類型：

#### 1. SYNONYM（同義 SKU）
**定義**：相同商品的不同編號或名稱

**使用場景**：
- 商品改版後 SKU 變更，但實際是相同商品
- 不同市場使用不同 SKU，但商品相同
- 舊 SKU 與新 SKU 的對應關係

**範例**：
- `PM6123456A` ↔ `PM6789012A`（同一商品，不同編號）

#### 2. FAMILY（家族商品）
**定義**：屬於同一家族的商品

**使用場景**：
- 相同產品線的不同型號
- 相同功能但規格不同的商品
- 系列商品

**範例**：
- `PM6123456A` ↔ `PM6123456B`（同家族，不同變體）
- `PM6123456A` ↔ `PM6123789A`（同家族，不同型號）

#### 3. PART（相關零件）
**定義**：商品的零件、配件或相關商品

**使用場景**：
- 主商品與配件的關係
- 主商品與替換零件的關係
- 組合商品與組成部分的關係

**範例**：
- `PM6123456A`（主商品）↔ `PM6999001A`（替換刀片）
- `MKC007104A`（切肉機）↔ `MKC007104B`（切片模組）

### 5.2 關聯管理

**建立關聯**：
- 僅管理員（Admin）可建立商品關聯
- 關聯是雙向的（A ↔ B）
- 同一對商品只能建立一種關聯類型

**查詢關聯**：
- 可查詢商品的所有關聯
- 可依關聯類型篩選
- 支援雙向查詢（A → B 或 B → A）

---

## 六、商品新增方式

### 6.1 手動新增

**權限要求**：僅管理員（Admin）

**必填資訊**：
- 商品編號（SKU）
- 商品名稱

**選填資訊**：
- 商品描述
- 商品縮圖

**驗證規則**：
- SKU 格式必須符合規範（英文3碼+數字6碼+A/B/C）
- SKU 不可重複
- 商品名稱不可為空

**自動計算**：
- 家族代碼（familyCode）：自動提取 SKU 前 6 碼
- 變體代碼（variant）：自動提取 SKU 最後 1 碼

### 6.2 批次匯入

**權限要求**：僅管理員（Admin）

**匯入格式**：CSV 或 Excel

**必填欄位**：
- `sku`：商品編號
- `name`：商品名稱

**選填欄位**：
- `description`：商品描述
- `thumbnailUrl`：商品縮圖網址

**匯入邏輯**：
1. 檢查 SKU 是否已存在
2. 若已存在，跳過該商品（不覆蓋）
3. 若不存在，新增商品
4. 回傳匯入結果統計（成功/跳過/失敗）

**錯誤處理**：
- 單一商品匯入失敗不影響其他商品
- 記錄失敗原因並回傳給使用者

---

## 七、商品搜尋與篩選

### 7.1 搜尋方式

**支援的搜尋欄位**：
- 商品編號（SKU）
- 商品名稱
- 商品描述

**搜尋特性**：
- 不區分大小寫
- 支援部分匹配（模糊搜尋）
- 自動轉換為大寫（SKU）

**範例**：
- 搜尋 `pm612` → 找到所有包含 `PM612` 的商品
- 搜尋 `切肉機` → 找到所有名稱或描述包含「切肉機」的商品

### 7.2 篩選方式

**支援的篩選條件**：
- 標籤篩選（多選）
- 家族代碼篩選
- 變體代碼篩選

**篩選邏輯**：
- 多個標籤使用 OR 邏輯（符合任一標籤即可）
- 可與搜尋功能組合使用

### 7.3 排序方式

**支援的排序欄位**：
- 建立時間（createdAt）
- 商品編號（sku）
- 商品名稱（name）

**排序方向**：
- 升序（asc）
- 降序（desc）

---

## 八、常見問題（FAQ）

### Q1：什麼樣的商品應該納入商品知識中樞？

**A1**：符合以下條件的商品應納入：
1. 在影片中被介紹或展示的實體商品
2. 需要集中管理相關影片與資訊的商品
3. 具有明確商品編號（SKU）的商品
4. 有多個變體或家族成員的商品

**不適合納入的情況**：
- 影片主題不是商品介紹（例如：教學影片、娛樂影片）
- 沒有明確商品編號的商品
- 一次性提及的商品（不需要知識管理）

### Q2：SKU 格式為什麼要這麼嚴格？

**A2**：嚴格的 SKU 格式有以下好處：
1. **唯一性保證**：避免 SKU 重複或衝突
2. **家族識別**：前 6 碼可自動識別家族關係
3. **變體管理**：最後 1 碼可區分不同變體
4. **資料一致性**：統一格式便於查詢與管理

### Q3：如果商品編號不符合格式怎麼辦？

**A3**：有以下解決方案：
1. **調整 SKU 格式**：將商品編號調整為符合規範的格式
2. **使用別名**：在商品描述中註記原始編號
3. **建立對應表**：使用 SYNONYM 關聯類型建立新舊 SKU 對應

### Q4：一個影片可以關聯多個商品嗎？

**A4**：
- **目前機制**：不支援（`videos.productId` 只能儲存單一商品編號）
- **建議改善**：建立 `video_products` 中介資料表，支援多對多關聯
- **替代方案**：在影片描述中列出所有相關商品編號

### Q5：如何管理商品家族關係？

**A5**：商品家族關係有兩種管理方式：
1. **自動識別**：系統自動根據 SKU 前 6 碼（familyCode）分組
2. **手動建立**：使用 FAMILY 關聯類型手動建立家族關係

**建議**：
- 優先使用自動識別（基於 familyCode）
- 僅在特殊情況下使用手動建立（例如：跨家族的相關商品）

### Q6：商品刪除後會影響相關影片嗎？

**A6**：
- **目前機制**：不會影響（`videos.productId` 是字串欄位，不受外鍵約束）
- **建議改善**：使用 `video_products` 中介資料表後，可設定級聯刪除或保留關聯

**最佳實務**：
- 刪除商品前，先檢查是否有相關影片
- 若有相關影片，先移除關聯或轉移到其他商品
- 避免直接刪除有相關影片的商品

---

## 九、總結

商品知識中樞的定義規則主要包含：

1. **SKU 格式規範**：`英文3碼 + 數字6碼 + A/B/C`
2. **家族代碼**：SKU 前 6 碼自動識別家族關係
3. **商品關聯**：支援 SYNONYM、FAMILY、PART 三種關聯類型
4. **影片關聯**：透過 `productId` 欄位關聯（建議改善為中介資料表）
5. **權限控制**：僅管理員可新增、編輯、刪除商品

**下一步行動**：
- 實作商品詳情頁面（Phase 62）
- 優化商品與影片關聯機制（Phase 64）
- 完善商品家族視覺化（Phase 65）
