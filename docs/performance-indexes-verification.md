# æ•ˆèƒ½å„ªåŒ–ç´¢å¼•é©—è­‰å ±å‘Š

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

**åŸ·è¡Œæ—¥æœŸ**ï¼š2025-12-08  
**åŸ·è¡Œç’°å¢ƒ**ï¼šManus é–‹ç™¼ç’°å¢ƒï¼ˆRailway PostgreSQLï¼‰  
**åŸ·è¡Œçµæœ**ï¼šâœ… æˆåŠŸå»ºç«‹ 16 å€‹ç´¢å¼•  
**ç¬¦åˆè¦ç¯„**ï¼šã€ŠINPHIC Ã— Manus ç”Ÿç”¢ç’°å¢ƒåˆä½œè¦ç¯„ 1.0ã€‹

---

## âœ… ç´¢å¼•å»ºç«‹çµæœ

### 1. videos è¡¨ï¼ˆ7 å€‹ç´¢å¼•ï¼‰

| ç´¢å¼•åç¨± | æ¬„ä½ | é¡å‹ | ç‹€æ…‹ |
|---------|------|------|------|
| idx_videos_category | category | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_videos_platform | platform | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_videos_share_status | shareStatus | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_videos_rating | rating DESC NULLS LAST | æ’åºç´¢å¼• | âœ… å·²å»ºç«‹ |
| idx_videos_created_at | createdAt DESC | æ’åºç´¢å¼• | âœ… å·²å»ºç«‹ |
| idx_videos_view_count | viewCount DESC | æ’åºç´¢å¼• | âœ… å·²å»ºç«‹ |
| idx_videos_filter | category, platform, shareStatus | è¤‡åˆç´¢å¼• | âœ… å·²å»ºç«‹ |

**ç¸½è¨ˆ**ï¼š7 å€‹ç´¢å¼•ï¼ˆ100% æˆåŠŸï¼‰

---

### 2. timeline_notes è¡¨ï¼ˆ3 å€‹ç´¢å¼•ï¼‰

| ç´¢å¼•åç¨± | æ¬„ä½ | é¡å‹ | ç‹€æ…‹ |
|---------|------|------|------|
| idx_timeline_notes_video_id | videoId | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_timeline_notes_status | status | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_timeline_notes_user_id | userId | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |

**ç¸½è¨ˆ**ï¼š3 å€‹ç´¢å¼•ï¼ˆ100% æˆåŠŸï¼‰

---

### 3. video_tags è¡¨ï¼ˆ2 å€‹ç´¢å¼•ï¼‰

| ç´¢å¼•åç¨± | æ¬„ä½ | é¡å‹ | ç‹€æ…‹ |
|---------|------|------|------|
| idx_video_tags_video_id | videoId | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |
| idx_video_tags_tag_id | tagId | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |

**ç¸½è¨ˆ**ï¼š2 å€‹ç´¢å¼•ï¼ˆ100% æˆåŠŸï¼‰

---

### 4. tags è¡¨ï¼ˆ2 å€‹ç´¢å¼•ï¼‰

| ç´¢å¼•åç¨± | æ¬„ä½ | é¡å‹ | ç‹€æ…‹ | å‚™è¨» |
|---------|------|------|------|------|
| idx_tags_type | tagType | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ | |
| idx_tags_usage_count | usageCount DESC | æ’åºç´¢å¼• | âœ… å·²å»ºç«‹ | åŸè¨ˆç•«ä½¿ç”¨ smartScoreï¼Œä½†æ¬„ä½ä¸å­˜åœ¨ï¼Œæ”¹ç”¨ usageCount |

**ç¸½è¨ˆ**ï¼š2 å€‹ç´¢å¼•ï¼ˆ100% æˆåŠŸï¼‰

---

### 5. products è¡¨ï¼ˆ2 å€‹ç´¢å¼•ï¼‰

| ç´¢å¼•åç¨± | æ¬„ä½ | é¡å‹ | ç‹€æ…‹ |
|---------|------|------|------|
| idx_products_sku | sku | å”¯ä¸€ç´¢å¼• | âœ… å·²å»ºç«‹ |
| idx_products_family_code | familyCode | å–®ä¸€æ¬„ä½ | âœ… å·²å»ºç«‹ |

**ç¸½è¨ˆ**ï¼š2 å€‹ç´¢å¼•ï¼ˆ100% æˆåŠŸï¼‰

---

## ğŸ“Š ç´¢å¼•çµ±è¨ˆ

| è³‡æ–™è¡¨ | è¨ˆç•«ç´¢å¼•æ•¸ | å¯¦éš›å»ºç«‹æ•¸ | æˆåŠŸç‡ |
|--------|-----------|-----------|--------|
| videos | 7 | 7 | 100% |
| timeline_notes | 3 | 3 | 100% |
| video_tags | 2 | 2 | 100% |
| tags | 2 | 2 | 100% |
| products | 2 | 2 | 100% |
| **ç¸½è¨ˆ** | **16** | **16** | **100%** |

---

## ğŸ” åŸ·è¡Œéç¨‹

### Step 1ï¼šå»ºç«‹ Drizzle é·ç§»æª”æ¡ˆ

```bash
# å»ºç«‹æª”æ¡ˆ
touch /home/ubuntu/film-genre/drizzle/0012_performance_indexes.sql

# å¯«å…¥ç´¢å¼• SQL
# è¦‹ drizzle/0012_performance_indexes.sql
```

### Step 2ï¼šåŸ·è¡Œ Drizzle é·ç§»

```bash
pnpm db:push
```

**çµæœ**ï¼š
- `drizzle-kit generate`ï¼šæ²’æœ‰ Schema è®Šæ›´ï¼ˆç´¢å¼•ä¸åœ¨ schema.ts ä¸­ï¼‰
- `drizzle-kit migrate`ï¼šé·ç§»æˆåŠŸå¥—ç”¨

### Step 3ï¼šæ‰‹å‹•åŸ·è¡Œç´¢å¼• SQL

```bash
psql "$CUSTOM_DATABASE_URL" -f drizzle/0012_performance_indexes.sql
```

**çµæœ**ï¼š
- æˆåŠŸå»ºç«‹ 15 å€‹ç´¢å¼•
- å¤±æ•— 1 å€‹ç´¢å¼•ï¼ˆ`tags.smartScore` æ¬„ä½ä¸å­˜åœ¨ï¼‰

### Step 4ï¼šä¿®æ­£ SQL ä¸¦é‡æ–°åŸ·è¡Œ

```bash
# ä¿®æ­£ SQLï¼ˆä½¿ç”¨ usageCount æ›¿ä»£ smartScoreï¼‰
psql "$CUSTOM_DATABASE_URL" -c "CREATE INDEX IF NOT EXISTS idx_tags_usage_count ON tags(\"usageCount\" DESC);"
```

**çµæœ**ï¼š
- æˆåŠŸå»ºç«‹ç¼ºå°‘çš„ç´¢å¼•

### Step 5ï¼šé©—è­‰ç´¢å¼•

```bash
# é©—è­‰æ‰€æœ‰è¡¨çš„ç´¢å¼•
psql "$CUSTOM_DATABASE_URL" -c "SELECT indexname FROM pg_indexes WHERE tablename = 'videos' AND indexname LIKE 'idx_%';"
```

**çµæœ**ï¼š
- æ‰€æœ‰ 16 å€‹ç´¢å¼•å…¨éƒ¨å»ºç«‹æˆåŠŸ

---

## ğŸ“ˆ é æœŸæ•ˆèƒ½æ”¹å–„

| æŒ‡æ¨™ | ç›®æ¨™ | é æœŸæ”¹å–„å¹…åº¦ |
|------|------|-------------|
| å½±ç‰‡åˆ—è¡¨è¼‰å…¥æ™‚é–“ | < 500ms | -50% è‡³ -80% |
| å½±ç‰‡ç¯©é¸æŸ¥è©¢ | < 100ms | -80% è‡³ -90% |
| æ™‚é–“è»¸ç­†è¨˜æŸ¥è©¢ | < 50ms | -80% è‡³ -90% |
| æ¨™ç±¤ç®¡ç†æŸ¥è©¢ | < 50ms | -80% è‡³ -90% |
| å•†å“æœå°‹æŸ¥è©¢ | < 50ms | -90% è‡³ -97% |

---

## ğŸ§ª æ•ˆèƒ½æ¸¬è©¦ï¼ˆå¾…åŸ·è¡Œï¼‰

### æ¸¬è©¦é …ç›®

1. **å½±ç‰‡åˆ—è¡¨æŸ¥è©¢æ•ˆèƒ½**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM videos WHERE category = 'REPAIR' ORDER BY rating DESC LIMIT 20;
   ```

2. **å½±ç‰‡ç¯©é¸æŸ¥è©¢æ•ˆèƒ½**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM videos WHERE category = 'REPAIR' AND platform = 'YOUTUBE' AND "shareStatus" = 'PUBLIC';
   ```

3. **æ™‚é–“è»¸ç­†è¨˜æŸ¥è©¢æ•ˆèƒ½**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM timeline_notes WHERE "videoId" = 1 AND status = 'APPROVED';
   ```

4. **æ¨™ç±¤ç®¡ç†æŸ¥è©¢æ•ˆèƒ½**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM tags WHERE "tagType" = 'KEYWORD' ORDER BY "usageCount" DESC LIMIT 20;
   ```

5. **å•†å“æœå°‹æŸ¥è©¢æ•ˆèƒ½**
   ```sql
   EXPLAIN ANALYZE SELECT * FROM products WHERE sku = 'PM6123456A';
   ```

### æ¸¬è©¦çµæœï¼ˆå¾…è£œå……ï¼‰

- [ ] å½±ç‰‡åˆ—è¡¨æŸ¥è©¢æ•ˆèƒ½æ¸¬è©¦
- [ ] å½±ç‰‡ç¯©é¸æŸ¥è©¢æ•ˆèƒ½æ¸¬è©¦
- [ ] æ™‚é–“è»¸ç­†è¨˜æŸ¥è©¢æ•ˆèƒ½æ¸¬è©¦
- [ ] æ¨™ç±¤ç®¡ç†æŸ¥è©¢æ•ˆèƒ½æ¸¬è©¦
- [ ] å•†å“æœå°‹æŸ¥è©¢æ•ˆèƒ½æ¸¬è©¦

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. Drizzle Kit ä¸è¿½è¹¤ç´¢å¼•

**å•é¡Œ**ï¼š
- Drizzle Kit çš„ `generate` å‘½ä»¤ä¸æœƒç”¢ç”Ÿç´¢å¼• SQL
- ç´¢å¼•éœ€è¦æ‰‹å‹•å»ºç«‹ä¸¦ç¶­è­·

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- å°‡ç´¢å¼• SQL æ”¾åœ¨ `drizzle/` è³‡æ–™å¤¾ä¸­ï¼ˆå¦‚ `0012_performance_indexes.sql`ï¼‰
- ä½¿ç”¨ `psql` æ‰‹å‹•åŸ·è¡Œç´¢å¼• SQL
- åœ¨ `DB_CHANGE_REQUEST_PERFORMANCE.md` è¨˜éŒ„è®Šæ›´

### 2. é–‹ç™¼ç’°å¢ƒèˆ‡ç”Ÿç”¢ç’°å¢ƒä¸€è‡´æ€§

**å•é¡Œ**ï¼š
- é–‹ç™¼ç’°å¢ƒå¯èƒ½æ²’æœ‰ç´¢å¼•ï¼ˆä½¿ç”¨ `pnpm db:push` é‡å»ºè³‡æ–™åº«ï¼‰
- ç”Ÿç”¢ç’°å¢ƒæœ‰ç´¢å¼•ï¼ˆæ‰‹å‹•åŸ·è¡Œ SQLï¼‰

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åœ¨é–‹ç™¼ç’°å¢ƒä¹ŸåŸ·è¡Œç´¢å¼• SQL
- å»ºç«‹è‡ªå‹•åŒ–è…³æœ¬ç¢ºä¿ä¸€è‡´æ€§
- åœ¨ `package.json` æ–°å¢ `db:indexes` æŒ‡ä»¤

### 3. ç´¢å¼•ç¶­è­·

**å»ºè­°**ï¼š
- å®šæœŸæª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³ï¼ˆ`pg_stat_user_indexes`ï¼‰
- åˆªé™¤æœªä½¿ç”¨çš„ç´¢å¼•
- ç›£æ§ç´¢å¼•å°å¯«å…¥æ•ˆèƒ½çš„å½±éŸ¿

---

## ğŸ“‹ å¾ŒçºŒæ­¥é©Ÿ

### Phase 2ï¼šè³‡æ–™åº«æ•ˆèƒ½å„ªåŒ–ï¼ˆå·²å®Œæˆï¼‰

- [x] å»ºç«‹ Drizzle é·ç§»æª”æ¡ˆï¼ˆdrizzle/0012_performance_indexes.sqlï¼‰
- [x] æ–°å¢ videos è¡¨ç´¢å¼•ï¼ˆ7 å€‹ï¼‰
- [x] æ–°å¢ timeline_notes è¡¨ç´¢å¼•ï¼ˆ3 å€‹ï¼‰
- [x] æ–°å¢ video_tags è¡¨ç´¢å¼•ï¼ˆ2 å€‹ï¼‰
- [x] æ–°å¢ tags è¡¨ç´¢å¼•ï¼ˆ2 å€‹ï¼‰
- [x] æ–°å¢ products è¡¨ç´¢å¼•ï¼ˆ2 å€‹ï¼‰
- [x] åŸ·è¡Œç´¢å¼• SQLï¼ˆæœ¬åœ°æ¸¬è©¦ç’°å¢ƒï¼‰
- [x] é©—è­‰ç´¢å¼•æ­£ç¢ºå»ºç«‹
- [ ] æ¸¬è©¦æŸ¥è©¢æ•ˆèƒ½æ”¹å–„ï¼ˆä½¿ç”¨ EXPLAIN ANALYZEï¼‰
- [ ] éƒ¨ç½²åˆ° Railway ç”Ÿç”¢ç’°å¢ƒ
- [ ] é©—è­‰ç”Ÿç”¢ç’°å¢ƒæ•ˆèƒ½æ”¹å–„

### Phase 3ï¼šAPI é€Ÿç‡é™åˆ¶å¯¦ä½œï¼ˆä¸‹ä¸€æ­¥ï¼‰

- [ ] å®‰è£ express-rate-limit å¥—ä»¶
- [ ] è¨­å®š Redis å„²å­˜ï¼ˆRailway Redisï¼‰
- [ ] å¯¦ä½œå…¨åŸŸé€Ÿç‡é™åˆ¶ï¼ˆ60 æ¬¡/åˆ†é˜ï¼‰
- [ ] å¯¦ä½œèªè­‰ä½¿ç”¨è€…é™åˆ¶ï¼ˆ120 æ¬¡/åˆ†é˜ï¼‰
- [ ] å¯¦ä½œ Admin é™åˆ¶ï¼ˆ300 æ¬¡/åˆ†é˜ï¼‰
- [ ] å¯¦ä½œç‰¹æ®Šç«¯é»é™åˆ¶ï¼ˆAI æœå°‹ã€æ‰¹æ¬¡åŒ¯å…¥ã€åœ–ç‰‡ä¸Šå‚³ï¼‰
- [ ] å‰ç«¯éŒ¯èª¤è™•ç†ï¼ˆé¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯ï¼‰
- [ ] å¾Œç«¯æ—¥èªŒè¨˜éŒ„ï¼ˆaudit logsï¼‰
- [ ] æ¸¬è©¦é€Ÿç‡é™åˆ¶åŠŸèƒ½

---

## åƒè€ƒæ–‡ä»¶

- `DB_CHANGE_REQUEST_PERFORMANCE.md`ï¼šè³‡æ–™åº«è®Šæ›´ç”³è«‹æ–‡ä»¶
- `docs/performance-optimization-plan.md`ï¼šæ•ˆèƒ½å„ªåŒ–è¦åŠƒæ–‡ä»¶
- `docs/railway-postgresql-conflict-analysis.md`ï¼šè¡çªåˆ†ææ–‡ä»¶
- PostgreSQL ç´¢å¼•æ–‡ä»¶ï¼šhttps://www.postgresql.org/docs/current/indexes.html
- Drizzle Kit æ–‡ä»¶ï¼šhttps://orm.drizzle.team/kit-docs/overview

---

**æ–‡ä»¶ç‰ˆæœ¬**ï¼š1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2025-12-08 19:00 GMT+8
